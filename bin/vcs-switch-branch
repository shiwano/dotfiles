#!/usr/bin/env bash

set -euo pipefail

usage() {
	local fd="${1:-2}"
	cat <<EOF >&"$fd"
Usage: vcs-switch-branch

Interactively select a branch/bookmark and switch to it (Git or jj).

Examples:
  vcs-switch-branch
EOF
}

main() {
	if [[ "${1:-}" == "--help" || "${1:-}" == "-h" ]]; then
		usage 1
		return 0
	fi

	if jj root >/dev/null 2>&1; then
		local bookmarks
		bookmarks="$(jj bookmark list 2>/dev/null || true)"
		[ -z "$bookmarks" ] && return 0

		local selected
		# shellcheck disable=SC2016
		selected="$(echo -e "$bookmarks" | fzf --no-sort --preview '' --prompt 'JJBookmark> ' | awk '{print $1}' | sed 's/:$//')"
		[ -z "$selected" ] && return 0

		jj edit "$selected"
	else
		local branches
		branches="$(git mru | tac || true)"
		[ -z "$branches" ] && return 0

		local selected
		# shellcheck disable=SC2016
		selected="$(echo -e "$branches" | fzf --no-sort --preview '' --prompt 'GitSwitch> ' | cut -d' ' -f1)"
		[ -z "$selected" ] && return 0

		git switch "$selected"
	fi
	return 0
}

main "$@"
