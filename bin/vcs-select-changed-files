#!/usr/bin/env bash

set -euo pipefail

usage() {
	local fd="${1:-2}"
	cat <<EOF >&"$fd"
Usage: vcs-select-changed-files [dir]

Interactively select changed/added/untracked files (Git or jj).

Examples:
  vcs-select-changed-files
EOF
}

main() {
	if [[ "${1:-}" == "--help" || "${1:-}" == "-h" ]]; then
		usage 1
		return 0
	fi

	local prompt="${FZF_PROMPT:-Select> }"

	local files
	local selected
	if jj root >/dev/null 2>&1; then
		files="$(jj status --no-pager | grep -E '^\w ' | grep -v -E '^D ')"
		[ -z "$files" ] && return 0

		# shellcheck disable=SC2016
		selected="$(echo -e "$files" | fzf -m --preview 'fzf-preview diff $(echo {} | cut -c3-)' --prompt "$prompt" | cut -c3-)"
	else
		files="$(git status -s -u --no-renames | grep -v -E '^D ')"
		[ -z "$files" ] && return 0

		# shellcheck disable=SC2016
		selected="$(echo -e "$files" | fzf -m --preview 'fzf-preview diff $(echo {} | cut -c3-)' --prompt "$prompt" | cut -c3-)"
	fi

	[ -z "$selected" ] && return 0

	echo "$selected"
}

main "$@"
